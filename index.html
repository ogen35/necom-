<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>å…«å®«æ ¼ç…§ç‰‡åˆæˆå™¨ Â· æ—¥ç³»æ‚è´§åº—Â·å–µ</title>
  <!-- Favicon / App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop stop-color='%23FFF7D6'/%3E%3Cstop offset='1' stop-color='%23FFE8A3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23g)'/%3E%3Cg fill='%236b4e16'%3E%3Ccircle cx='20' cy='20' r='8'/%3E%3Ccircle cx='40' cy='12' r='7'/%3E%3Ccircle cx='60' cy='20' r='8'/%3E%3Ccircle cx='80' cy='14' r='6'/%3E%3Cpath d='M30,55c10,-14 30,-14 40,0c-10,10 -30,10 -40,0Z'/%3E%3C/g%3E%3C/svg%3E"/>
  <link rel="apple-touch-icon" href="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop stop-color='%23FFF7D6'/%3E%3Cstop offset='1' stop-color='%23FFE8A3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' ry='20' fill='url(%23g)'/%3E%3Cg fill='%236b4e16'%3E%3Ccircle cx='20' cy='20' r='8'/%3E%3Ccircle cx='40' cy='12' r='7'/%3E%3Ccircle cx='60' cy='20' r='8'/%3E%3Ccircle cx='80' cy='14' r='6'/%3E%3Cpath d='M30,55c10,-14 30,-14 40,0c-10,10 -30,10 -40,0Z'/%3E%3C/g%3E%3C/svg%3E"/>

  <!-- Open Graph / Twitter Cards -->
  <meta name="theme-color" content="#F7C948" />
  <meta property="og:title" content="å…«å®«æ ¼ç…§ç‰‡åˆæˆå™¨ Â· æ—¥ç³»æ‚è´§åº—Â·å–µ" />
  <meta property="og:description" content="æŠŠç…§ç‰‡æ‹–è¿›æ ¼å­é‡Œï¼Œæ”¯æŒç¼©æ”¾/ç§»åŠ¨ï¼Œä¸€é”®å¯¼å‡ºã€‚æ—¥ç³»é»„è°ƒ + çŒ«å’ªæ°›å›´ï¼Œéšæœºå¼¹å¹•æ›´æœ‰è¶£ã€‚" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:image" content="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop stop-color='%23FFF7D6'/%3E%3Cstop offset='1' stop-color='%23FFE8A3'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='630' fill='url(%23g)'/%3E%3Ctext x='60' y='200' font-family='system-ui, -apple-system, Segoe UI, PingFang SC, sans-serif' font-size='72' fill='%238E6A00' font-weight='800'%3Eå…«å®«æ ¼ç…§ç‰‡åˆæˆå™¨%3C/text%3E%3Ctext x='60' y='280' font-family='system-ui, -apple-system, Segoe UI, PingFang SC, sans-serif' font-size='36' fill='%236b4e16'%3Eæ—¥ç³»æ‚è´§åº—Â·å–µ%3C/text%3E%3Cg fill='%236b4e16' transform='translate(900,260) scale(1.4)'%3E%3Ccircle cx='20' cy='20' r='8'/%3E%3Ccircle cx='40' cy='12' r='7'/%3E%3Ccircle cx='60' cy='20' r='8'/%3E%3Ccircle cx='80' cy='14' r='6'/%3E%3Cpath d='M30,55c10,-14 30,-14 40,0c-10,10 -30,10 -40,0Z'/%3E%3C/g%3E%3C/svg%3E" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- PWA Manifest: è¿è¡Œæ—¶æ³¨å…¥ï¼ˆé¿å…å•ç‹¬æ–‡ä»¶ï¼‰ -->
  <script>
    (function(){
      const iconSvg = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%23FFF7D6'/><stop offset='1' stop-color='%23FFE8A3'/></linearGradient></defs><rect width='100' height='100' fill='url(%23g)'/><g fill='%236b4e16'><circle cx='20' cy='20' r='8'/><circle cx='40' cy='12' r='7'/><circle cx='60' cy='20' r='8'/><circle cx='80' cy='14' r='6'/><path d='M30,55c10,-14 30,-14 40,0c-10,10 -30,10 -40,0Z'/></g></svg>";
      // ç”¨ canvas æŠŠ SVG è½¬ä¸º PNG DataURL ä¾› manifest ä½¿ç”¨ï¼ˆæ›´é«˜å…¼å®¹æ€§ï¼‰
      function svgToPngDataURL(svgUrl, size){
        return new Promise((resolve)=>{
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = function(){
            const c = document.createElement('canvas'); c.width=size; c.height=size;
            const cctx = c.getContext('2d');
            cctx.fillStyle = '#FFE8A3'; cctx.fillRect(0,0,size,size);
            cctx.drawImage(img, 0, 0, size, size);
            resolve(c.toDataURL('image/png'));
          };
          img.src = svgUrl;
        });
      }
      Promise.all([svgToPngDataURL(iconSvg, 192), svgToPngDataURL(iconSvg, 512)]).then(([i192,i512])=>{
        const manifest = {
          name: 'å…«å®«æ ¼ç…§ç‰‡åˆæˆå™¨ Â· æ—¥ç³»æ‚è´§åº—Â·å–µ',
          short_name: 'çŒ«çŒ«æ‚è´§åº—',
          start_url: '.',
          scope: '.',
          display: 'standalone',
          background_color: '#FFF7D6',
          theme_color: '#F7C948',
          icons: [
            { src: i192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
            { src: i512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest'; link.href = url;
        document.head.appendChild(link);
      });
    })();
  </script>
  <style>
    :root{
      --primary:#F7C948;           /* æ˜äº®é»„ */
      --primary-2:#FFD166;         /* æŸ”é»„ */
      --primary-3:#FFB703;         /* æ·±ä¸€ç‚¹çš„é»„ */
      --ink:#4A3B2F;               /* æ£•è‰²æ–‡å­— */
      --bg-grad:linear-gradient(135deg,#FFF7D6 0%,#FFE8A3 100%);
      --btn-grad:linear-gradient(135deg,#FFD166 0%,#FFB703 100%);
      --btn-grad-danger:linear-gradient(135deg,#FF9AA2 0%,#FF5C7A 100%);
      --glass:rgba(255,255,255,.85);
      --accent: #E07A5F;           /* èµ¤èŒ¶ */
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      color: var(--ink);
      background: var(--bg-grad);
      min-height: 100vh;
      padding-bottom: 40px;
      position: relative;
    }

    /* æ—¥ç³»å°åº—é¡¶æ£šï¼ˆé®é˜³ç¯·ï¼‰ */
    .awning {
      position: sticky; top:0; z-index: 120;
      background: repeating-linear-gradient(90deg, #fff 0 60px, #FFE08A 60px 120px);
      height: 24px; box-shadow: 0 6px 0 rgba(0,0,0,.05);
    }

    header {
      padding: 18px 20px; gap: 14px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 24px; z-index: 110;
      border-bottom: 2px dashed #F1C40F22;
    }
    header h1 {
      margin: 0; font-size: 22px; font-weight: 800; letter-spacing: .5px;
      background: linear-gradient(135deg,#C68B00 0%, #8E6A00 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      display:flex; align-items:center; gap:8px;
    }
    header h1 .cat { font-size: 24px; }

    main { padding: 26px 18px; display:flex; flex-direction:column; align-items:center; gap: 18px; }

    #canvasContainer { position: relative; max-width: 100%; width: fit-content; background: #fffdf6; border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,.12); border: 2px solid #FFE08A; }
    #canvas { border-radius: 12px; max-width: 100%; height: auto; display:block; }

    #boxes { position:absolute; top:20px; left:20px; right:20px; bottom:20px; pointer-events:none; }

    .upload-box { position:absolute; border: 3px dashed rgba(247,201,72,.6); border-radius: 12px; background: rgba(255, 255, 255, 0.35); cursor: pointer; transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease; pointer-events:auto; overflow:hidden; }
    .upload-box:hover { border-color: rgba(255,183,3,.85); background: rgba(255,248,220,.45); transform: scale(1.015); box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .upload-box.has-image { border-color: rgba(76, 175, 80, 0.4); background: rgba(255,255,255,.18); }

    .upload-label { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size: 44px; color: #E0B100AA; font-weight: 800; pointer-events:none; transition: transform .25s ease, opacity .25s; }
    .upload-box:hover .upload-label { transform: scale(1.07); opacity:.9; }
    .upload-box.has-image .upload-label { display:none; }

    .badge { position:absolute; top:10px; left:10px; background: var(--btn-grad); color: #5A3E00; width: 32px; height:32px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size: 16px; font-weight: 800; box-shadow: 0 2px 8px rgba(0,0,0,.18); z-index: 10; border:1px solid #FFE08A; }

    .replace { position:absolute; right:10px; top:10px; z-index:11; background: #fff9; border:1px solid #E6C200; border-radius: 999px; padding: 6px 10px; font-size:12px; color:#7A5A00; backdrop-filter: blur(6px); display:none; }
    .upload-box.has-image:hover .replace{ display:block; }

    .hint { position:absolute; bottom:8px; right:8px; z-index:11; background:#0008; color:#fff; font-size:12px; padding:4px 8px; border-radius: 999px; display:none; }
    .upload-box.has-image:hover .hint{ display:block; }

    .controls { display:flex; gap: 12px; flex-wrap: wrap; justify-content:center; }
    button { background: var(--btn-grad); color: #4B3A00; border:none; padding: 12px 22px; border-radius: 12px; cursor:pointer; font-size: 15px; font-weight: 800; box-shadow: 0 4px 15px rgba(255,183,3,.35); transition: transform .18s ease, box-shadow .25s ease; display:flex; align-items:center; gap:8px; }
    button:hover { transform: translateY(-1.5px); box-shadow: 0 6px 18px rgba(255,183,3,.45); }
    button:active { transform: translateY(0); }
    button.secondary { background: #fff; color:#8E6A00; border:2px solid #F7C948; box-shadow: 0 4px 15px rgba(0,0,0,.06); }
    button.danger { background: var(--btn-grad-danger); color:#5E0B1B; box-shadow: 0 4px 15px rgba(255,92,122,.35); }

    .tips { background: var(--glass); padding: 18px; border-radius: 12px; max-width: 640px; text-align:left; box-shadow: 0 4px 15px rgba(0,0,0,.08); border: 1px dashed #E6C20066; }
    .tips h3{ margin:0 0 10px 0; color:#7A5A00; }
    .tips ul{ margin:0; padding-left: 20px; color:#6b5a3a; line-height:1.8; }

    /* iPad */
    @media (max-width: 1024px){ #canvas{ width:100%; } }
    /* Mobile */
    @media (max-width: 768px){
      header h1{ font-size:18px; }
      button{ padding: 10px 16px; font-size: 14px; }
      main{ padding: 16px 10px; }
      #canvasContainer{ padding: 10px; }
      .badge{ width:28px; height:28px; font-size:14px; }
      .upload-label{ font-size:36px; }
      .tips{ font-size:14px; }
    }

    /* åŠ è½½åŠ¨ç”»ä¸å¼¹å¹• */
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .loading{ animation:pulse 1.5s ease-in-out infinite; }

    .danmu-layer{ position:fixed; left:0; right:0; top:0; bottom:0; pointer-events:none; overflow:hidden; z-index:150; }
    .danmu{ position:absolute; white-space:nowrap; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.9); border:1px solid #FFE08A; box-shadow:0 4px 10px rgba(0,0,0,.08); color:#6b4e16; font-weight:700; }
    @keyframes fly { from{ transform: translateX(100vw);} to{ transform: translateX(-120%);} }

    /* çŒ«å’ªè„šå°è§’æ ‡ */
    .paws{ position: fixed; right: 12px; bottom: 12px; width: 80px; opacity:.25; z-index: 5; }
  </style>
</head>
<body>
  <div class="awning"></div>
  <header>
    <h1><span class="cat">ğŸ¾</span> ğŸ“¸ å…«å®«æ ¼ç…§ç‰‡åˆæˆå™¨ Â· ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼</h1>
    <input type="file" id="bgInput" accept="image/*" style="display:none" />
    <button class="secondary" onclick="document.getElementById('bgInput').click()">ğŸ–¼ï¸ ä¸Šä¼ èƒŒæ™¯</button>
  </header>

  <main>
    <div id="canvasContainer">
      <canvas id="canvas" width="1365" height="2048"></canvas>
      <div id="boxes"></div>
    </div>

    <div class="controls">
      <button onclick="downloadImage()">ğŸ’¾ å¯¼å‡ºåˆæˆå›¾</button>
      <button class="danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    </div>

    <div class="tips">
      <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
      <ul>
        <li>ç‚¹å‡»ä»»æ„æ ¼å­ä¸Šä¼ ç…§ç‰‡ï¼Œæ”¯æŒ JPG/PNG</li>
        <li>é¼ æ ‡æ»šè½®/åŒæŒ‡æåˆï¼š<b>ç¼©æ”¾</b>ï¼›æŒ‰ä½æ‹–åŠ¨ï¼š<b>ç§»åŠ¨</b></li>
        <li>ç‚¹å·¦ä¸Šåœ†ç‚¹å¯é‡æ–°é€‰æ‹©è¯¥æ ¼ç…§ç‰‡</li>
        <li>å¯ä¸Šä¼ è‡ªå®šä¹‰èƒŒæ™¯æˆ–ä½¿ç”¨é»˜è®¤æ—¥ç³»é»„è°ƒèƒŒæ™¯</li>
      </ul>
    </div>
  </main>

  <!-- å¼¹å¹•å›¾å±‚ï¼ˆå¯å…³é—­çš„è¯åªéœ€æ³¨é‡Š spawnDanmu è°ƒç”¨ï¼‰ -->
  <div class="danmu-layer" id="danmuLayer"></div>

  <!-- å¯çˆ±è„šå° -->
  <svg class="paws" viewBox="0 0 100 100" fill="currentColor"><g fill="#6b4e16"><circle cx="20" cy="20" r="8"/><circle cx="40" cy="12" r="7"/><circle cx="60" cy="20" r="8"/><circle cx="80" cy="14" r="6"/><path d="M30,55c10,-14 30,-14 40,0c-10,10 -30,10 -40,0Z"/></g></svg>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const boxData = [
      { x: 64.2, y: 68.6 }, { x: 682.5, y: 68.6 },
      { x: 64.2, y: 497.3 }, { x: 682.5, y: 497.3 },
      { x: 64.2, y: 925.9 }, { x: 682.5, y: 925.9 },
      { x: 64.2, y: 1354.9 }, { x: 682.5, y: 1354.9 },
    ];
    const boxWidth = 604.6;
    const boxHeight = 405;
    const images = Array(8).fill(null);
    const transforms = Array(8).fill(0).map(()=>({scale:1, offsetX:0, offsetY:0}));
    let backgroundImage = null;
    let scale = 1; // å“åº”å¼å®¹å™¨ç¼©æ”¾

    // é»˜è®¤é»„è°ƒèƒŒæ™¯ï¼ˆSVGï¼‰
    const defaultBg = new Image();
    defaultBg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1365' height='2048'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23fff7d6'/%3E%3Cstop offset='100%25' style='stop-color:%23ffe8a3'/%3E%3C/linearGradient%3E%3Cpattern id='paw' width='120' height='120' patternUnits='userSpaceOnUse' patternTransform='rotate(15)'%3E%3Cg fill='%23efd36a' opacity='0.4'%3E%3Ccircle cx='20' cy='20' r='6'/%3E%3Ccircle cx='40' cy='12' r='5'/%3E%3Ccircle cx='60' cy='20' r='6'/%3E%3Ccircle cx='80' cy='14' r='4'/%3E%3Cpath d='M30,55c8,-10 24,-10 32,0c-8,8 -24,8 -32,0Z'/%3E%3C/g%3E%3C/pattern%3E%3C/defs%3E%3Crect width='1365' height='2048' fill='url(%23bg)'/%3E%3Crect width='1365' height='2048' fill='url(%23paw)'/%3E%3C/svg%3E";
    defaultBg.onload = function(){ backgroundImage = defaultBg; redraw(); };

    // å“åº”å¼ç¼©æ”¾ï¼ˆå†³å®šå¯ç‚¹å‡»ç›’å­çš„ä½ç½®å’Œå°ºå¯¸ï¼‰
    function updateScale(){
      const container = document.getElementById('canvasContainer');
      const containerWidth = container.offsetWidth - 40; // padding
      scale = Math.min(1, containerWidth / canvas.width);
      updateBoxes();
    }

    // èƒŒæ™¯ä¸Šä¼ 
    document.getElementById('bgInput').addEventListener('change', function(e){
      const file = e.target.files[0]; if(!file) return;
      const img = new Image();
      img.onload = function(){ backgroundImage = img; redraw(); };
      img.src = URL.createObjectURL(file);
    });

    // åˆ›å»ºä¸Šä¼ æ¡†å¹¶ç»‘å®šç¼©æ”¾/æ‹–æ‹½äº‹ä»¶
    function updateBoxes(){
      const boxesContainer = document.getElementById('boxes');
      boxesContainer.innerHTML = '';

      boxData.forEach((box, i)=>{
        const div = document.createElement('div');
        div.className = 'upload-box';
        if(images[i]) div.classList.add('has-image');

        div.style.left = (box.x * scale) + 'px';
        div.style.top = (box.y * scale) + 'px';
        div.style.width = (boxWidth * scale) + 'px';
        div.style.height = (boxHeight * scale) + 'px';

        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = i + 1;
        div.appendChild(badge);

        const label = document.createElement('div');
        label.className = 'upload-label';
        label.textContent = '+';
        div.appendChild(label);

        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.textContent = 'æ»šè½®/æåˆç¼©æ”¾ Â· æ‹–åŠ¨ç§»åŠ¨';
        div.appendChild(hint);

        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*'; input.style.display = 'none';
        input.onchange = (e)=> handleImage(i, e.target.files[0]);

        // åªæœ‰æ²¡æœ‰å›¾ç‰‡æ—¶ç‚¹å‡»æ‰è§¦å‘é€‰æ‹©
        if(!images[i]){ div.onclick = ()=> input.click(); }

        // å·¦ä¸Šè§’åœ†ç‚¹ä¹Ÿå¯é‡æ–°é€‰æ‹©
        badge.style.cursor = 'pointer';
        badge.onclick = (ev)=>{ ev.stopPropagation(); input.click(); };

        // å³ä¸Šè§’æ›´æ¢æŒ‰é’®ï¼ˆæ‚¬æµ®æ˜¾ç¤ºï¼‰
        const replace = document.createElement('button');
        replace.className = 'replace';
        replace.textContent = 'æ›´æ¢';
        replace.onclick = (ev)=>{ ev.stopPropagation(); input.click(); };
        div.appendChild(replace);

        // äº¤äº’ï¼šç¼©æ”¾ + æ‹–åŠ¨ï¼ˆæ¯æ ¼ç‹¬ç«‹çš„ transformï¼‰
        bindTransformInteractions(div, i);

        div.appendChild(input);
        boxesContainer.appendChild(div);
      });
    }

    function handleImage(index, file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const img = new Image();
        img.onload = function(){
          images[index] = img;
          transforms[index] = { scale: 1, offsetX: 0, offsetY: 0 };
          redraw(); updateBoxes();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function redraw(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      // èƒŒæ™¯
      if(backgroundImage){ ctx.drawImage(backgroundImage, 0,0, canvas.width, canvas.height); }

      // å…«å¼ å›¾ï¼ˆä½¿ç”¨ clip + è¦†ç›–æ¨¡å¼ + è‡ªå®šä¹‰ç¼©æ”¾/ä½ç§»ï¼‰
      boxData.forEach((box, i)=>{
        if(images[i]){
          const img = images[i];
          const t = transforms[i];
          const baseScale = Math.max(boxWidth / img.width, boxHeight / img.height); // cover
          const s = baseScale * t.scale;
          const drawW = img.width * s;
          const drawH = img.height * s;
          const dx = box.x + (boxWidth - drawW)/2 + t.offsetX;
          const dy = box.y + (boxHeight - drawH)/2 + t.offsetY;

          ctx.save();
          ctx.beginPath(); ctx.rect(box.x, box.y, boxWidth, boxHeight); ctx.clip();
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, dx, dy, drawW, drawH);
          ctx.restore();
        }
      });
    }

    function downloadImage(){
      const link = document.createElement('a');
      const date = new Date().toLocaleString('zh-CN').replace(/[/:]/g,'-');
      link.download = `å…«å®«æ ¼åˆæˆå›¾_${date}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    }

    function clearAll(){
      if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç…§ç‰‡å—ï¼Ÿ')){
        images.fill(null);
        transforms.forEach(t=>{ t.scale=1; t.offsetX=0; t.offsetY=0; });
        backgroundImage = defaultBg;
        redraw(); updateBoxes();
      }
    }

    // === äº¤äº’å®ç°ï¼šæ»šè½®/æåˆç¼©æ”¾ã€æ‹–æ‹½ç§»åŠ¨ ===
    function bindTransformInteractions(el, index){
      let dragging = false; let lastX=0, lastY=0;
      let pointers = new Map(); // for pinch zoom

      // é¼ æ ‡æ»šè½®ç¼©æ”¾
      el.addEventListener('wheel', (ev)=>{
        if(!images[index]) return; // æ— å›¾ä¸ç¼©æ”¾
        ev.preventDefault();
        const delta = -ev.deltaY; // ä¸Šæ»šæ”¾å¤§
        const factor = delta>0 ? 1.05 : 0.95;
        const t = transforms[index];
        // ä»¥æŒ‡é’ˆä½ç½®ä¸ºä¸­å¿ƒè¿›è¡Œå¾®è°ƒï¼ˆå°†åç§»å‘æŒ‡é’ˆé æ‹¢ï¼‰
        const rect = el.getBoundingClientRect();
        const cx = (ev.clientX - rect.left) / rect.width;  // 0~1
        const cy = (ev.clientY - rect.top) / rect.height;

        // æ›´æ–°ç¼©æ”¾
        const newScale = clamp(t.scale * factor, 0.5, 5);
        // è°ƒæ•´åç§»ï¼Œä¿æŒæŒ‡é’ˆä¸‹åƒç´ ä½ç½®ç›¸å¯¹ç¨³å®š
        const img = images[index];
        const baseScale = Math.max(boxWidth / img.width, boxHeight / img.height);
        const prevW = img.width * baseScale * t.scale;
        const prevH = img.height * baseScale * t.scale;
        const nextW = img.width * baseScale * newScale;
        const nextH = img.height * baseScale * newScale;
        const dx = (prevW - nextW) * (cx - 0.5);
        const dy = (prevH - nextH) * (cy - 0.5);

        t.scale = newScale;
        t.offsetX += dx; t.offsetY += dy;
        redraw();
      }, { passive:false });

      // æ‹–æ‹½ç§»åŠ¨ï¼ˆé¼ æ ‡ï¼‰
      el.addEventListener('mousedown', (ev)=>{
        if(!images[index]) return; dragging = true; lastX = ev.clientX; lastY = ev.clientY; ev.preventDefault(); });
      window.addEventListener('mousemove', (ev)=>{
        if(!dragging) return; const t = transforms[index];
        t.offsetX += (ev.clientX - lastX) / scale; // éœ€è¦é™¤ä»¥å®¹å™¨ç¼©æ”¾
        t.offsetY += (ev.clientY - lastY) / scale;
        lastX = ev.clientX; lastY = ev.clientY; redraw();
      });
      window.addEventListener('mouseup', ()=> dragging = false);

      // è§¦æ§ï¼šæŒ‡é’ˆäº‹ä»¶ï¼ˆå•æŒ‡æ‹–åŠ¨ï¼ŒåŒæŒ‡æåˆç¼©æ”¾ï¼‰
      el.addEventListener('pointerdown', (ev)=>{ if(!images[index]) return; el.setPointerCapture(ev.pointerId); pointers.set(ev.pointerId, {x:ev.clientX, y:ev.clientY}); });
      el.addEventListener('pointermove', (ev)=>{
        if(!images[index] || !pointers.has(ev.pointerId)) return;
        const prev = pointers.get(ev.pointerId);
        pointers.set(ev.pointerId, {x:ev.clientX, y:ev.clientY});
        if(pointers.size===1){ // å•æŒ‡æ‹–åŠ¨
          const t = transforms[index];
          t.offsetX += (ev.clientX - prev.x) / scale;
          t.offsetY += (ev.clientY - prev.y) / scale;
          redraw();
        } else if(pointers.size===2){ // åŒæŒ‡ç¼©æ”¾
          const [p1, p2] = Array.from(pointers.values());
          const [q1, q2] = Array.from(pointers.entries()).map(([id,p])=>({id, p}));
          // éœ€è¦ä¸Šä¸€å¸§çš„ä¸¤ç‚¹è·ç¦»ï¼Œç®€å•èµ·è§ç”¨ç§»åŠ¨å‰çš„ prev ä¸å¦ä¸€ç‚¹ç°å€¼ä¼°ç®—
          const otherId = q1.id===ev.pointerId ? q2.id : q1.id;
          const other = pointers.get(otherId);
          if(!other) return;
          const prevDist = Math.hypot(prev.x - other.x, prev.y - other.y);
          const nowDist = Math.hypot(ev.clientX - other.x, ev.clientY - other.y);
          const factor = clamp(nowDist/prevDist, 0.8, 1.25);
          const t = transforms[index];
          t.scale = clamp(t.scale * factor, 0.5, 5);
          redraw();
        }
      });
      el.addEventListener('pointerup', (ev)=>{ pointers.delete(ev.pointerId); });
      el.addEventListener('pointercancel', (ev)=>{ pointers.delete(ev.pointerId); });
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    // === å¼¹å¹• ===
    const DANMU_TEXTS = [
      'ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï½', 'æ¬¢è¿å…‰ä¸´å°çŒ«æ‚è´§åº—', 'ä»Šæ—¥ç‰¹å–ï¼šå–µå–µè´´çº¸', 'é™å®šå¸ƒä¸ç°åšç°å–', 'å–µï¼šè¯·æŠŠç›¸æœºç»™æˆ‘', 'å¯ä¸å¯å¥¶èŒ¶è¦æ¥ä¸€æ¯ï¼Ÿ', 'æ–°åˆ°è´§ï¼šå’Œçº¸èƒ¶å¸¦', 'æ‹ç…§è¦éœ²å‡ºç¬‘çœ¼(=^ï½¥Ï‰ï½¥^=)', 'å¤æ—¥åˆ¨å†°å¼€å–ä¸­', 'çŒ«æŒæ›²å¥‡é¦™å–·å–·', 'è°¢è°¢æƒ é¡¾ï½', 'å°å¿ƒï¼çŒ«çŒ«æ‰“ç›¹ä¸­', 'ä»Šæ—¥ç­¾åï¼šå¥½è¿æ¥', 'Neko says hi!', 'Kawaii~', 'æ‹å®Œè®°å¾—å¯¼å‡ºå“¦ï¼', 'æ‹›ç‰Œï¼šèœ‚èœœæŸšå­èŒ¶', 'æ…¢æ…¢è°ƒï¼Œåˆ«æ€¥ï½', 'ã¼ã¡ã¼ã¡è¡Œã“ã‹', 'å–µå–µç›‘å¬ing', 'ä»Šæ—¥è¿åŠ¿ï¼šå¤§å‰ï¼'
    ];

    function spawnDanmu(){
      const layer = document.getElementById('danmuLayer');
      const dm = document.createElement('div');
      dm.className = 'danmu';
      dm.textContent = DANMU_TEXTS[Math.floor(Math.random()*DANMU_TEXTS.length)];
      const top = Math.random() * (window.innerHeight * 0.7) + 20; // é¿å…é®ä½é¡¶éƒ¨æŒ‰é’®
      dm.style.top = top + 'px';
      const duration = 10 + Math.random()*10; // 10-20s
      dm.style.animation = `fly ${duration}s linear 1`;
      layer.appendChild(dm);
      // ç»“æŸç§»é™¤
      setTimeout(()=> layer.removeChild(dm), duration*1000);
    }

    // é—´éš”éšæœºç”Ÿæˆå¼¹å¹•
    function startDanmu(){
      // åˆå§‹å‡ æ¡
      for(let i=0;i<3;i++) setTimeout(spawnDanmu, i*1200);
      setInterval(()=>{ if(Math.random()>0.4) spawnDanmu(); }, 2500);
    }

    // åˆå§‹åŒ–
    window.addEventListener('resize', updateScale);
    window.addEventListener('load', function(){ updateScale(); updateBoxes(); startDanmu(); });
  </script>
</body>
</html>
